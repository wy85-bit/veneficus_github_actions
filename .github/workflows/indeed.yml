name: Run Indeed Scraper

on:
  workflow_dispatch:
  schedule:
    - cron: "0 7 * * *"

permissions:
  contents: write

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout the repo
        uses: actions/checkout@v4

      - name: Debug - show actual working directory
        run: |
          pwd
          echo "---- LIST ROOT ----"
          ls -la .
          echo "---- LIST REPO DIR ----"
          ls -la /home/runner/work
          ls -la /home/runner/work/${{ github.event.repository.name }}
          ls -la /home/runner/work/${{ github.event.repository.name }}/${{ github.event.repository.name }}

      - name: Detect working directory
        id: finddir
        run: |
          echo "Searching for scraper file..."
          SCRAPER=$(find . -maxdepth 5 -name "indeed_scraper.py" | head -n 1)
          echo "FOUND=$SCRAPER" >> $GITHUB_OUTPUT
          echo "Scraper found at: $SCRAPER"

      - name: Fail if scraper not found
        if: ${{ steps.finddir.outputs.FOUND == '' }}
        run: |
          echo "‚ùå indeed_scraper.py not found!"
          exit 1

      - name: Switch to correct folder
        run: |
          cd "$(dirname '${{ steps.finddir.outputs.FOUND }}')"
          echo "Now in:"
          pwd
        shell: bash

      - uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1

      - name: Install requirements
        run: pip install -r requirements.txt

      - name: Run scraper (auto-detected path)
        run: |
          SCRAPER=$(find . -name "indeed_scraper.py" -maxdepth 5 | head -n 1)
          echo "Found scraper at: $SCRAPER"
          cd $(dirname "$SCRAPER")
          echo "Running from directory:"
          pwd
          python indeed_scraper.py

      - name: Create test HTML (always)
        run: echo "<h1>test</h1>" > test_debug.html

      - name: Upload ALL HTML files recursively
        uses: actions/upload-artifact@v4
        with:
          name: debug_html
          path: "**/*.html"
      - name: Find scraper
        run: |
          echo "Searching for scraper file..."
          find . -name "indeed_scraper.py" -maxdepth 5
      - name: Upload ALL HTML debug files recursively
        uses: actions/upload-artifact@v4
        with:
          name: debug_html
          path: "**/*.html"

      - name: Commit JSON files
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          find . -name "indeed_*.json" -exec git add {} +
          if git diff --cached --quiet; then
            echo "No changes."
          else
            git commit -m "Indeed update $(date)"
            git push
          fi
